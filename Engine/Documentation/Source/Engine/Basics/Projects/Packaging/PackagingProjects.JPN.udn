INTSourceChangelist:3481084
Availability:Public
Title:プロジェクトのパッケージ化
Crumbs:
Description:配布用のアンリアル ゲームプロジェクトのパッケージ化
version:4.9
parent:Engine/Basics/Projects

[TOC(start:2)]



[EXCERPT:Intro]
アンリアル プロジェクトをユーザーへ配布する前に適切にパッケージ化処理をしなくてはいけません。パッケージ化処理することで全コードとコンテンツを最新に保ち、対象プラットフォームで実行可能な適切なフォーマットになるようにします。 
[/EXCERPT:Intro]

パッケージ化処理中は複数のステップが実行されます。プロジェクトがカスタム ソースコードで記述されている場合、まず最初にこのコードをコンパイルします。そして、全ての必須コンテンツを対象プラットフォームで利用できるフォーマットに変換 (いわゆるコンテンツのクック) しなくてはいけません。それが終わるとコンパイル済みのコードとクックされたコンテンツは、Windows インストーラーのような配布可能なファイル一式へまとめられます。


メインの **[File]** メニューに、サブメニューを含んだ **[Package Project]** オプションがあります。サブメニューには、パッケージ化処理の対象プラットフォームがすべて表示されます。パッケージ化処理の目的は、単一マップではなくゲーム全体をテストすること、または 
提出 / 配布用のゲームを準備することです。

Android プラットフォームに関しては、複数の選択肢があります。詳細は、Android Texture Formats のページを参照してください。

パッケージ化処理前に設定する **[Advanced]** オプションもいくつかあります。 

プラットフォームを選択すると、ゲームにコードが含まれる場合、エディタはゲームをコンパイル、ゲームデータ全てをクック、そしてコンテンツをパッケージ化処理します。プロジェクトに Starter Content が含まれると処理速度が低下します。 
もしくは、たくさんのテスト / 仮のコンテンツやマップを作成した場合も処理速度が低下します。


## ゲームのデフォルト マップの設定

ゲームをパッケージ化する前に、まずパッケージ化されたゲームの開始時に読み込まれる **Game Default Map** を設定する必要があります。マップを設定せずに、空のプロジェクトを使用している場合は、パッケージ化されたゲームの開始時に黒い画面しか表示されません。First Person や Third Person などのテンプレート マップのひとつを使用した場合は、開始時にマップが読み込まれます。

ゲームのデフォルト マップを設定するには、エディタのメイン メニューで **[Edit > Project Settings > Maps & Modes]** の順に選択してクリックします。

![](Project_Settings_MapsNModes.png)


## パッケージの作成

特定のプラットフォームを対象にプロジェクトをパッケージ化するには、エディタのメインメニューで **[File > Package Project > プラットフォーム名]** の順にクリックします。

![](packaging_menu.png)

ターゲット ディレクトリを選択するダイアログが表示されます。パッケージ化処理が完了すると、選択したディレクトリにパッケージ化されたプロジェクトが格納されます。

ターゲット ディレクトリが確認されると、選択したプラットフォーム向けにプロジェクトの実際のパッケージ処理が開始します。パッケージ処理は時間がかかるためバックグラウンドで実行され、ユーザーはエディタを継続して使用することができます。エディタの右下隅に、処理の進捗を示すステータス インジケータが表示されます。

![](progress.png)

このステータス インジケータには現在アクティブなパッケージ化処理を中止する **[Cancel]** ボタンがあります。また **[Show Log]** リンクをクリックすることにより、拡張した出力ログ情報を表示させることもできます。この出力ログの情報は、パッケージ処理が成功しなかった場合などの原因調査に役立ちます。

![](log.png)

エラーや警告など非常に重要なログ情報は通常の **メッセージログ** ウィンドウに記録が残ります。

![](message_log.png)

[REGION:note]
こうしたウィンドウがいずれも表示されない場合は、 **[Window** > **Developer Tools** > **Output Log** / **Message Log]** オプションからアクセスできます。
[/REGION]
 
## パッケージ化されたゲームの実行

パッケージ化処理を行う時には、出力用のディレクトリを選択しました。パッケージ化処理が正常に完了すると、パッケージ化されたゲームはプラットフォーム専用のサブディレクトリに入ります。例えば、 TappyChicken/Final を選択した場合、iOS ビルドは TappyChicken/Final/IOS に、  
Android ビルドは TappyChicken/Final/Android に入ります。選択したサブディレクトリへ移動すると、パッケージ化済みのゲームがプラットフォームに適したフォーマットで見つかります。 
Android の場合、「.apk」、「.obb」、「.bat」のファイルがあります (デバイスにゲームをインストールするには「.bat」ファイルを実行します)。IOS プラットフォームの場合、「.ipa」ファイルがあります。このファイルは、iTunes または Xcode 経由でインストールします。
作成されるファイルの数や種類は対象プラットフォームによって異なります。以下の画像は Windows 向けプロジェクトの出力例です。

![](results.png)

[EXCERPT:RunCooked]
**パッケージ化したゲームを実行する方法**

1. 以下のテーブルを参照してパッケージ化したゲームの実行ファイルを検索します。

	| Configuration | EXE Name                             | EXE Location |
	| ------------- | ------------------------------------ | --------------------------------------------------------------- |
	| Development   | [ProjectName].exe                    | [PackageDirectory]\WindowsNoEditor |
	| Shipping      | [ProjectName]-Win32-Shipping.exe     | [PackageDirectory]\WindowsNoEditor |

1. 実行ファイルを **ダブルクリック** してゲームを実行します。
[/EXCERPT:RunCooked]


## 配布

IOS あるいは Android ゲームを App Store や Google Play Store にサブミットするには、ご自分のパッケージを Distribution モードで作成する必要があります。そのためには、**[Packaging]** メニューの **[Packaging Settings]** オプションの 
[Distribution] チェックボックスにチェックを入れます。これで最終パッケージが正しく署名されます。

IOS の場合、Apple の Developer サイトでディストリビューション証明書および モバイル プロビジョニングを作成する必要があります。開発証明書の場合と同じように証明書をインストールし、 
もう 1 つのファイルの隣に「Distro_」プレフィックスの付いた名前をディストリビューション プロビジョニングに付けます (「Distro_MyProject.mobileprovision」と「MyProject.mobileprovision」ができます)。

Android の場合、.apk を署名するキーを作成し、「SigningConfig.xml」と呼ばれるファイルでビルド ツールに情報を提供する必要があります。このファイルはインストール済みの「Engine」ディレクトリ、 
(Engine/Build/Android/Java) にあります。このファイルを編集すると、すべてのプロジェクトに適用されます。ただし、プロジェクトの「Build/Android」ディレクトリ (Java ディレクトリではない) にこのファイルをコピーすることができ、 
ファイルはそのプロジェクトのみに使用されます。キーを生成し、ファイルに入力する手順は、ファイルそのものの中に入っています。


## 詳細設定

メインメニューで [ **File > Package Project > Packaging Settings...** ] または [**Edit > Project Settings > Packaging**] の順に選択してクリックすると、パッケージ化の詳細設定オプションが表示されます。

![](settings.png)

 現時点では以下のオプションを使用することができます。

| オプション | 説明 |
| ------ | ----------- |
| Build Configuration | コードベースのプロジェクトをコンパイルするビルドのコンフィギュレーションです。デバッグ作業には [Debug] を選択、他の大半のプロジェクトで最小限のデバッグ サポートで、より優れたパフォーマンスには [Development] を選択、そして最終出荷用ビルドには [Shipping] を選択します。 |
| Staging Directory | パッケージ化したビルドを格納するディレクトリです。ターゲット ディレクトリの選択時に別のディレクトリを選択すると、このオプションは自動的に更新されます。 |
| Full Rebuild | 全コードをコンパイルするか否かを設定します。無効な場合、修正されたコードのみがコンパイルされます。これによりパッケージ処理が迅速化する場合があります。出荷ビルドは、ビルド漏れや古いコンテンツを含まないためにも常にフルの再ビルドを実行してください。このオプションはデフォルト設定で有効です。 |
| Use Pak File | 個々のファイルまたは単一パッケージとしてプロジェクトのアセットをパッケージ化するか否かを設定します。有効な場合、各ファイル全てをコピーする代わりに、全アセットを単一「.pak」ファイルに格納します。プロジェクトにたくさんのアセットファイルがある場合、「.pak」ファイルを使用した方が配布が容易になる場合があります。多くのファイルを移動する必要がないからです。このオプションはデフォルト設定で有効です。 |
| Generate Chunks | インストールのストリーミングで使用可能な .pak ファイルのチャンクを生成するかどうかを設定します。|
| Build Http Chunk Install Data | HTTP チャンク インストーラ向けにデータを生成するかどうかを設定します。これにより、ランタイムにインストールするようにウェブ サーバー上にデータをホストすることができます。 |
| Http Chunk Install Data Directory | データをビルドするディレクトリです。 |
| Http Chunk Install Data Version | HTTP チャンク インストール データのバージョン名です。 |
| Include Prerequisites | 再配布可能なオペレーティング システムのコンポーネントなど、パッケージ化したゲームの前提条件を含むかどうかを指定します。 |
[PUBLISH:Licensee]
| Directories to Always Cook | 常にクックが必須であるファイルを含んだディレクトリのリストです。デフォルト設定では、パッケージ化機能がゲームで参照する全てのコンテンツを自動的に検知してクックします。必須コンテンツの中には、カスタム スレート UI のテクスチャなど、直接参照されないコンテンツもあります。このようなコンテンツが格納されているディレクトリは、パッケージに含まれるように、ここにリスト化します。 |
[/PUBLISH:Licensee]


## コンテンツのクック

デベロッパーとして新規または修正したゲーム コンテンツをイタレーションする時に、まずステージン グディレクトリへ全てをパッケージ化し、その後そこから実行するという冗長な処理を行いたくない場合もあることでしょう。そのような場合、[ **File > Cook Content **] の順に選択して [プラットフォーム名] をクリックして、パッケージ化せずに特定のターゲット プラットフォームのコンテンツのみをクックすることも可能です。

この機能は、プロジェクトのローカルのデベロッパーのワークスペースにあるコンテンツを更新し、ステージング ディレクトリへアセットをコピーしません。イタレーションを迅速に行うために、ローカルのデベロッパー ワークスペースから直接ゲームを実行することができます。


## ロード時間を最適化する

オープン ワールドのゲームではロード時間が短いことが不可欠ですが、あらゆるタイプのゲームでもこれは価値があります。アンリアル エンジンでは、パッケージ化処理中のプロジェクトのロード時間を最適化する方法がいくつかあります。ゲームのロード時間を短縮する推奨方法を以下に示します。プロジェクトのパッケージ方法については、[](Engine/Deployment) セクションをご覧ください。

### Event Driven Loader (EDL) と Asyncronous Loading Thread (ALT) を使用する

* **Asynchronous Loading Thread** (ALT) はデフォルトでオフになっていますが、 [Project Settings] メニューの [Engine - Streaming] セクションでオンにすることができます。修正したエンジンでは一部微調整が必要になるかもしれませんが、一般的に ALT はロードの速度を 2 倍速くします。これには事前のロード時間があるゲームと絶えずデータをストリーミングするゲームを含みます。ALT はシリアライズとポスト ローディング コードを 2 つの別個のスレッドで同時に実行することで機能します。その結果、ゲーム コード内の `UObject` クラス コンストラクタ、 `PostInitProperties` 関数、および `Serialize` 関数がスレッドセーフでなければならないという要件が加わります。アクティベートすると、ALT によってローディング速度が 2 倍速くなります。非同期ローディング (C++) の使用に関する情報は、[](Programming\Assets\AsyncLoading) のページをご覧ください。

* **Event-Driven Loader** はデフォルトでオンになっていますが、 [Project Settings] メニューの [Engine - Streaming] セクションでオフにすることができます。ほとんどのプロジェクトで EDL はロード時間を半分に短縮します。EDL は安定していてアンリアル エンジンの古いバージョンに移植することができます。または改良、カスタマイズしたエンジン バージョン向けに微調整することができます。

![](EngineStreamingSettings.png)

### .pak ファイルの圧縮

* プロジェクトで .pak ファイルの圧縮を使うには、 [Project Settings (プロジェクト設定)] を開いて [Packaging (パッケージ化)] セクションを探します。このセクションで、 [Packaging] の見出しの advanced (詳細) 部分を開いて、表示される [Create compressed cooked packages (圧縮されたクック ページの作成) ] のチェックボックスにチェックを入れます。

* ほとんどのプラットフォームには自動圧縮機能はなく、.pak ファイルを圧縮するとロード時間が一般的に短縮しますが、以下のように考慮すべき特殊なケースがあります。

| プラットフォーム | 推奨 |
| -- | -- |
| Sony PlayStation 4 | .pak ファイルを圧縮することは、PlayStation 4 のすべてのタイトルで自動的に適用される圧縮と重複し、実際にはファイル サイズは減らずにロード時間が長くなってしまいます。従って、PlayStation 4 向けのリリースでは、.pak ファイルの圧縮はお勧めしません。 |
| Nintendo Switch | Switch 上の圧縮した .pak ファイルのロードは時間がかかることがあります。これは、データ解凍に時間がかかるためですが、圧縮ファイルから高速にロードすることもあります。Switch 向けタイトルでは、個々のタイトルでロード時間をテストし、ケースバイケースで決定を下すことをお勧めします。 |
| Microsoft XBoxOne | Microsoft の XBoxOne プラットフォームのファイルは自動的に圧縮されますが、圧縮した .pak ファイルをさらに圧縮してもメリットがないことをシステムは認識します。その結果、システムは圧縮を適用するのではなく、圧縮 .pak ファイルをそのままにします。最終的に、XBoxOne リリース向けに .pak ファイルを圧縮しても、最終製品に大きな影響はありません。 |
| Steam | Steam ではユーザーがダウンロードしているときにファイルを圧縮します。そのため、ダウンロード時間は圧縮されているゲームの .pak ファイルによる影響を受けません。ただし、Steam の差分パッチ システムの方が圧縮されていないファイルではうまく機能します。圧縮 .pak ファイルはカスタマーのシステムの空間を節約しますが、パッチの場合はダウンロード時間が長くなります。 |

![Project Settings - Compress Pak option](Project_Settings_PakCompression.png)
[REGION:caption] .pak ファイルの圧縮を有効にするには、このボックスにチェックを入れます。[/REGION]

### .pak ファイルを順序付けする

* .pak ファイルを適切に順序付けすることは、ロード時間を短縮するうえで重要です。.pak ファイルを最適に順序付けするために、アンリアル エンジンにはデータ アセットを必要とする順序を見つけるツール一式があり、高速にロードするパッケージをビルドします。概念上はこのプロセスはプロファイルによる最適化に似ています。.pak ファイルを順序付けするには以下の手順に従います。

1. パッケージ化したゲームを "-fileopenlog" コマンドライン オプションを使ってビルドし実行します。このオプションは、エンジンにファイルを開く順序を記録させます。
1. ゲームのすべての主要エリアに対して行ないます。すべてのレベル、プレイ可能なキャラクター、武器、ビークルなどをロードします。すべてがロードされたら、ゲームを終了します。
1. デプロイしたゲームに `GameOpenOrder.log` というファイルがあります。これには .pak ファイルの順序を最適化するために必要な情報があります。例えば、Windows のビルドでは、このファイルは `WindowsNoEditor/(YourGame)/Build/WindowsNoEditor/FileOpenOrder/` にあります。このファイルを `/Build/WindowsNoEditor/FileOpenOrder/` パスの development ディレクトリにコピーします。
1. ログ ファイルができたら、.pak ファイルを再ビルドします。これと今後生成される.pak ファイルはログ ファイルに示されているファイルの順序を使用します。

* 本番環境では、ログ ファイルはソース コントロールにチェックインされ、新しい "-fileopenlog" の実行結果を使って定期的に更新されます。これには、ゲームの出荷準備が整った最終実行が含まれます。
